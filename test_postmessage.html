<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>postMessage Bridge Test</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: system-ui, sans-serif;
      background: #f3f4f6;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    h1 {
      color: #1f2937;
      margin-bottom: 20px;
    }
    .iframe-container {
      width: 100%;
      height: 600px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 8px;
    }
    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    button {
      padding: 10px 20px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }
    button:active {
      transform: translateY(0);
    }
    .info {
      background: #f0f9ff;
      border: 1px solid #bfdbfe;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
    }
    .log {
      background: #1f2937;
      color: #f9fafb;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    .log-entry {
      margin-bottom: 5px;
      padding: 3px 0;
      border-bottom: 1px solid #374151;
    }
    .log-entry:last-child {
      border-bottom: none;
    }
    .log-entry.success { color: #6ee7b7; }
    .log-entry.error { color: #fca5a5; }
    .log-entry.info { color: #93c5fd; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”Œ postMessage Bridge Test - v7.5-main Viewer</h1>

    <div class="info">
      <strong>Instructions:</strong> This page tests the cross-origin postMessage bridge.
      Use the buttons below to send commands to the iframe.
      Check the log for responses.
    </div>

    <div class="iframe-container">
      <iframe
        id="presentation-iframe"
        src="http://localhost:8504/p/92efc791-d99b-44eb-b777-adfa6e1c8e54"
      ></iframe>
    </div>

    <div class="controls">
      <h3>Navigation Controls</h3>
      <div class="button-group">
        <button onclick="sendCmd('prevSlide')">â¬…ï¸ Previous</button>
        <button onclick="sendCmd('nextSlide')">Next â¡ï¸</button>
        <button onclick="sendCmd('getCurrentSlideInfo')">â„¹ï¸ Get Slide Info</button>
        <button onclick="sendCmd('goToSlide', {index: 5})">Go to Slide 5</button>
      </div>

      <h3>Edit Mode Controls</h3>
      <div class="button-group">
        <button onclick="sendCmd('toggleEditMode')">âœï¸ Toggle Edit</button>
        <button onclick="sendCmd('saveAllChanges')">ğŸ’¾ Save Changes</button>
        <button onclick="sendCmd('cancelEdits')">âŒ Cancel Edits</button>
      </div>

      <h3>View Controls</h3>
      <div class="button-group">
        <button onclick="sendCmd('toggleOverview')">ğŸ“Š Toggle Overview</button>
        <button onclick="sendCmd('isOverviewActive')">ğŸ” Check Overview Status</button>
      </div>

      <h3>Debug Functions</h3>
      <div class="button-group">
        <button onclick="sendCmd('toggleGridOverlay')">ğŸ¯ Toggle Grid</button>
        <button onclick="sendCmd('toggleBorderHighlight')">ğŸ”² Toggle Borders</button>
      </div>

      <h3>Text Formatting API (v7.5.3)</h3>
      <div class="button-group">
        <button onclick="sendCmd('getSelectionInfo')">ğŸ“‹ Get Selection Info</button>
        <button onclick="sendCmd('formatText', {bold: 'toggle'})">B Toggle Bold</button>
        <button onclick="sendCmd('formatText', {italic: 'toggle'})">I Toggle Italic</button>
        <button onclick="sendCmd('formatText', {underline: 'toggle'})">U Toggle Underline</button>
        <button onclick="sendCmd('formatText', {color: '#ef4444'})">ğŸ”´ Red Text</button>
        <button onclick="sendCmd('formatText', {color: '#3b82f6'})">ğŸ”µ Blue Text</button>
        <button onclick="sendCmd('formatText', {fontSize: '24px'})">ğŸ“ Large Font</button>
        <button onclick="sendCmd('formatText', {alignment: 'center'})">â¬› Center</button>
        <button onclick="sendCmd('formatText', {listType: 'bullet'})">â€¢ Bullet List</button>
      </div>
      <div class="button-group">
        <button onclick="sendCmd('updateSectionContent', {slideIndex: 0, sectionId: 'slide-0-section-title', content: '<h1 style=&quot;color:#1e40af&quot;>Updated Title!</h1>'})">ğŸ“ Update Title Section</button>
      </div>

      <h3>Dynamic Elements API (v7.5.3)</h3>
      <div class="button-group">
        <button onclick="insertTestShape()">â¬› Insert Rectangle</button>
        <button onclick="insertTestCircle()">âšª Insert Circle</button>
        <button onclick="insertTestTable()">ğŸ“Š Insert Table</button>
        <button onclick="insertTestChart()">ğŸ“ˆ Insert Chart</button>
        <button onclick="insertTestImage()">ğŸ–¼ï¸ Insert Image</button>
        <button onclick="deleteLastElement()">ğŸ—‘ï¸ Delete Last Element</button>
      </div>

      <h3>Review Mode (AI Selection)</h3>
      <div class="button-group">
        <button onclick="sendCmd('toggleReviewMode')">ğŸ“‹ Toggle Review Mode</button>
        <button onclick="sendCmd('getSelectedSections')">ğŸ“Œ Get Selected Sections</button>
        <button onclick="sendCmd('clearSelection')">âŒ Clear Selection</button>
      </div>

      <h3>Test Log</h3>
      <div class="log" id="log"></div>
    </div>
  </div>

  <script>
    const iframe = document.getElementById('presentation-iframe');
    const logEl = document.getElementById('log');
    const VIEWER_ORIGIN = 'http://localhost:8504';

    // Log function
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
      console.log(message);
    }

    // Listen for responses from iframe
    window.addEventListener('message', (event) => {
      if (event.origin !== VIEWER_ORIGIN) return;

      const { action, success, error, data } = event.data;

      if (success) {
        log(`âœ… ${action} - SUCCESS ${JSON.stringify(data || {})}`, 'success');
      } else {
        log(`âŒ ${action} - FAILED: ${error}`, 'error');
      }
    });

    // Send command to iframe
    function sendCmd(action, params = {}) {
      log(`ğŸ“¤ Sending: ${action} ${JSON.stringify(params)}`, 'info');
      iframe.contentWindow.postMessage({ action, params }, VIEWER_ORIGIN);
    }

    // Wait for iframe to load
    iframe.addEventListener('load', () => {
      log('ğŸ‰ Iframe loaded - ready to test!', 'success');
    });

    // Track inserted elements for deletion
    let insertedElements = [];

    // Helper functions for Dynamic Elements API tests
    function insertTestShape() {
      sendCmd('insertShape', {
        slideIndex: 0,
        type: 'rectangle',
        gridRow: '5/10',
        gridColumn: '3/15',
        fill: '#3b82f6',
        stroke: '#1e40af',
        strokeWidth: 2
      });
    }

    function insertTestCircle() {
      sendCmd('insertShape', {
        slideIndex: 0,
        type: 'circle',
        gridRow: '6/12',
        gridColumn: '20/28',
        fill: '#10b981',
        stroke: '#059669',
        strokeWidth: 2
      });
    }

    function insertTestTable() {
      sendCmd('insertTable', {
        slideIndex: 0,
        gridRow: '10/16',
        gridColumn: '2/18',
        tableHtml: `<table>
          <thead>
            <tr><th>Metric</th><th>Q3</th><th>Q4</th><th>Change</th></tr>
          </thead>
          <tbody>
            <tr><td>Revenue</td><td>$1.2M</td><td>$1.5M</td><td>+25%</td></tr>
            <tr><td>Users</td><td>50K</td><td>75K</td><td>+50%</td></tr>
            <tr><td>NPS</td><td>72</td><td>85</td><td>+13</td></tr>
          </tbody>
        </table>`
      });
    }

    function insertTestChart() {
      sendCmd('insertChart', {
        slideIndex: 0,
        gridRow: '3/15',
        gridColumn: '18/32',
        chartConfig: {
          type: 'bar',
          data: {
            labels: ['Q1', 'Q2', 'Q3', 'Q4'],
            datasets: [{
              label: 'Revenue ($M)',
              data: [12, 19, 15, 25],
              backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: true, position: 'top' },
              title: { display: true, text: 'Quarterly Revenue' }
            }
          }
        }
      });
    }

    function insertTestImage() {
      sendCmd('insertImage', {
        slideIndex: 0,
        gridRow: '2/9',
        gridColumn: '22/31',
        imageUrl: 'https://images.unsplash.com/photo-1552664730-d307ca884978?w=600',
        alt: 'Team collaboration'
      });
    }

    function deleteLastElement() {
      if (insertedElements.length > 0) {
        const lastId = insertedElements.pop();
        sendCmd('deleteElement', { elementId: lastId });
      } else {
        log('âš ï¸ No tracked elements to delete', 'error');
      }
    }

    // Track inserted elements from responses
    const originalHandler = window.onmessage;
    window.addEventListener('message', (event) => {
      if (event.origin !== VIEWER_ORIGIN) return;
      const { action, success, data } = event.data;
      if (success && data && data.elementId) {
        insertedElements.push(data.elementId);
        log(`ğŸ“ Tracking element: ${data.elementId}`, 'info');
      }
    });

    log('ğŸš€ Test page initialized (v7.5.3 with Dynamic Elements)', 'info');
  </script>
</body>
</html>
